{% extends "base.html" %}

{% block title %}SEARCH_RESULTS - DOC AGENT{% endblock %}

{% block content %}
<div class="mb-8">
    <div
        class="flex flex-col md:flex-row justify-between items-center gap-4 bg-retro-card border-2 border-retro-border p-4 rounded-lg box-glow">
        <div>
            <h2 class="font-arcade text-xl text-retro-primary text-glow-primary mb-2">
                <i class="fas fa-search mr-2"></i>SEARCH_RESULTS
            </h2>
            <p class="font-terminal text-retro-muted text-sm flex items-center gap-2">
                <i class="fas fa-quote-left text-xs"></i>
                <strong class="text-retro-text">{{ query }}</strong>
                <i class="fas fa-quote-right text-xs"></i>
            </p>
        </div>
        <div>
            <a href="{{ url_for('index') }}"
                class="btn-retro text-retro-secondary border-retro-secondary hover:bg-retro-secondary/10">
                <i class="fas fa-arrow-left mr-2"></i>BACK HOME
            </a>
        </div>
    </div>
</div>

<!-- Search Again Section -->
<div class="mb-8">
    <div class="bg-retro-card border-2 border-retro-border rounded-lg p-6 box-glow">
        <div class="text-center mb-4">
            <h3 class="font-arcade text-lg text-retro-primary mb-2">
                <i class="fas fa-search mr-2"></i>SEARCH AGAIN
            </h3>
        </div>

        <form action="{{ url_for('unified_search') }}" method="post" id="unified-search-form" class="max-w-2xl mx-auto">
            <div class="relative group">
                <div
                    class="absolute -inset-0.5 bg-gradient-to-r from-retro-primary to-retro-secondary rounded opacity-50 group-hover:opacity-100 transition duration-200 blur">
                </div>
                <div class="relative flex">
                    <input type="text" name="query" id="search-input"
                        class="w-full bg-retro-bg border-2 border-retro-border text-retro-text font-terminal text-lg p-3 focus:outline-none focus:border-retro-secondary placeholder-retro-muted/50"
                        placeholder="> INPUT SEARCH QUERY..." autocomplete="off">
                    <button
                        class="bg-retro-bg border-2 border-l-0 border-retro-border text-retro-secondary px-5 hover:bg-retro-secondary/10 transition-colors"
                        type="submit" id="search-btn">
                        <i class="fas fa-search text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Advanced Search Options -->
            <div class="mt-3">
                <button type="button" id="advanced-toggle" class="font-terminal text-sm text-retro-muted hover:text-retro-text transition-colors">
                    <i class="fas fa-cog mr-2"></i>ADVANCED OPTIONS <i class="fas fa-chevron-down ml-2"></i>
                </button>
                <div id="advanced-options" class="mt-3 hidden">
                    <div class="bg-retro-bg border border-retro-border rounded p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="max_candidates" class="font-arcade text-xs text-retro-text mb-2 block">
                                    SEARCH DEPTH (MAX CANDIDATES)
                                </label>
                                <input type="number" name="max_candidates" id="max_candidates"
                                    class="w-full bg-retro-bg border border-retro-border text-retro-text font-terminal text-sm p-2 focus:outline-none focus:border-retro-secondary placeholder-retro-muted/50"
                                    placeholder="Default: 50" min="1" max="500">
                                <small class="font-terminal text-retro-muted text-xs mt-1 block">
                                    Higher values may find more results but take longer to search
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Summary -->
<div
    class="mb-6 bg-retro-success/10 border border-retro-success/30 p-3 rounded text-retro-success font-terminal flex items-center gap-2">
    <i class="fas fa-check-circle"></i>
    <span>FOUND {{ results | length }} RELEVANT FILE{{ 'S' if results | length != 1 else '' }}
        {% if results and results[0].relevance_score is not none %}
        <span class="text-retro-primary">(AI-POWERED RAG ANALYSIS APPLIED)</span>
        {% endif %}
    </span>
</div>

<!-- Search Results -->
{% if results %}
<div class="space-y-6">
    {% for result in results %}
    <div
        class="bg-retro-bg border-2 border-retro-border rounded-lg overflow-hidden hover:border-retro-primary transition-all duration-300 group">
        <div
            class="bg-retro-bg border-b-2 border-retro-border p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="text-2xl text-retro-secondary group-hover:text-retro-primary transition-colors">
                    {{ get_file_icon(result.metadata.file_extension) }}
                </div>
                <h6 class="font-arcade text-sm md:text-base">
                    <a href="{{ url_for('document_detail', doc_id=result['id']) }}"
                        class="text-retro-text hover:text-retro-primary transition-colors">
                        {{ result.filename }}
                    </a>
                </h6>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                {% if result.similarity is not none %}
                {% set score_percent = result.similarity * 100 %}
                {% set score_color = 'text-retro-success border-retro-success' if score_percent >= 85 else
                'text-retro-secondary border-retro-secondary' if score_percent >= 51 else 'text-retro-accent
                border-retro-accent' %}
                <span class="font-arcade text-xs px-2 py-1 border {{ score_color }} rounded bg-retro-bg">
                    <i class="fas fa-brain mr-1"></i>SIMILARITY: {{ "%.1f"|format(score_percent) }}%
                </span>
                {% endif %}
                {% if result.relevance_score is not none %}
                {% set relevance_percent = result.relevance_score * 100 %}
                {% set relevance_color = 'text-retro-success border-retro-success' if relevance_percent >= 80 else
                'text-retro-warning border-retro-warning' if relevance_percent >= 60 else 'text-retro-accent
                border-retro-accent' %}
                <span class="font-arcade text-xs px-2 py-1 border {{ relevance_color }} rounded bg-retro-bg">
                    <i class="fas fa-robot mr-1"></i>RAG: {{ "%.1f"|format(relevance_percent) }}%
                </span>
                {% endif %}
                {% for category in result.categories.split('-') %}
                {% if category %}
                <span
                    class="font-arcade text-xs px-2 py-1 bg-retro-primary/10 text-retro-primary border border-retro-primary/30 rounded">{{
                    category | upper }}</span>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <h6 class="font-arcade text-xs text-retro-muted mb-2">
                        <i class="fas fa-folder mr-1"></i>LOCATION: <span class="font-terminal text-retro-text">{{
                            result.file_path }}</span>
                    </h6>
                    <div class="content-preview">
                        <strong class="font-terminal text-retro-muted text-xs block mb-2">CONTENT_PREVIEW:</strong>
                        <div class="font-terminal text-sm text-retro-muted p-3 border border-retro-border rounded bg-retro-bg/50 markdown-preview overflow-auto"
                            data-content="{{ result.content_preview | truncate_content(300) }}"></div>
                    </div>
                    {% if result.relevance_reasoning %}
                    <div class="mt-4">
                        <strong class="font-terminal text-retro-muted text-xs block mb-2">
                            <i class="fas fa-robot mr-1"></i>RAG_ANALYSIS:
                        </strong>
                        <div class="font-terminal text-sm text-retro-text p-3 border border-retro-primary/30 rounded bg-retro-primary/5">
                            {{ result.relevance_reasoning }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="md:col-span-1 border-t md:border-t-0 md:border-l border-retro-border pt-4 md:pt-0 md:pl-4">
                    <div class="grid grid-cols-2 md:grid-cols-1 gap-4 text-center md:text-left">
                        <div>
                            <small class="font-terminal text-retro-muted text-xs block">FILE_SIZE</small>
                            <span class="font-arcade text-sm text-retro-text">{{ "%.1f"|format(result.metadata.file_size
                                / 1024) }} KB</span>
                        </div>
                        <div>
                            <small class="font-terminal text-retro-muted text-xs block">TYPE</small>
                            <span class="font-arcade text-sm text-retro-text">{{ result.metadata.file_extension | upper
                                }}</span>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <small class="font-terminal text-retro-muted text-xs block">CLASSIFIED</small>
                            <span class="font-arcade text-sm text-retro-text">{{ result.classification_date |
                                format_date }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-retro-card border-t-2 border-retro-border p-3 flex justify-end gap-3">
            <a href="{{ url_for('document_detail', doc_id=result['id']) }}"
                class="btn-retro text-xs py-1 px-3 text-retro-primary border-retro-primary hover:bg-retro-primary/10">
                <i class="fas fa-eye mr-2"></i>VIEW_DETAILS
            </a>
            <button class="btn-retro text-xs py-1 px-3 text-retro-muted border-retro-muted hover:bg-retro-muted/10"
                onclick="copyPath('{{ result.file_path }}')">
                <i class="fas fa-copy mr-2"></i>COPY_PATH
            </button>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="text-center py-16 border-2 border-dashed border-retro-border rounded-lg opacity-50">
    <i class="fas fa-search text-4xl text-retro-muted mb-4"></i>
    <h4 class="font-arcade text-retro-muted mb-2">NO_RESULTS_FOUND</h4>
    <p class="font-terminal text-retro-muted mb-6">TRY DIFFERENT QUERY OR CHECK EMBEDDINGS STATUS.</p>
    <a href="{{ url_for('index') }}"
        class="btn-retro text-retro-primary border-retro-primary hover:bg-retro-primary/10 inline-block">
        <i class="fas fa-home mr-2"></i>BACK HOME
    </a>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const searchForm = document.getElementById('unified-search-form');
        const advancedToggle = document.getElementById('advanced-toggle');
        const advancedOptions = document.getElementById('advanced-options');

        // Handle advanced options toggle
        if (advancedToggle && advancedOptions) {
            advancedToggle.addEventListener('click', function () {
                const isHidden = advancedOptions.classList.contains('hidden');
                if (isHidden) {
                    advancedOptions.classList.remove('hidden');
                    advancedToggle.querySelector('.fa-chevron-down').style.transform = 'rotate(180deg)';
                } else {
                    advancedOptions.classList.add('hidden');
                    advancedToggle.querySelector('.fa-chevron-down').style.transform = 'rotate(0deg)';
                }
            });
        }

        // Handle form submission
        if (searchForm) {
            searchForm.addEventListener('submit', function (e) {
                const query = searchInput.value.trim();

                // If query starts with "category:", treat it as category search
                if (query.toLowerCase().startsWith('category:')) {
                    const category = query.substring(9).trim(); // Remove "category:" prefix
                    if (category) {
                        // Change form action to category search
                        searchForm.action = '{{ url_for("category_search") }}';
                        // Update the input name to match what category_search expects
                        searchInput.name = 'category';
                        searchInput.value = category;
                    } else {
                        e.preventDefault();
                        alert('Please specify a category after "category:"');
                        return;
                    }
                } else {
                    // Default to semantic search
                    searchForm.action = '{{ url_for("semantic_search") }}';
                    searchInput.name = 'query';
                }
            });
        }
    });

    function cleanAndRenderMarkdown(content) {
        const cleaned = content
            .replace(/<\|ref\|>[^<]*<\|\/ref\|>/g, '')
            .replace(/<\|det\|>[^<]*<\|\/det\|>/g, '')
            .replace(/<\|image\|>[^<]*<\|\/image\|>/g, '')
            .replace(/\n{3,}/g, '\n\n')
            .trim();

        const rendered = marked.parse(cleaned, {
            breaks: true,
            gfm: true
        });

        return rendered;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const previewElements = document.querySelectorAll('.markdown-preview');
        previewElements.forEach(element => {
            const rawContent = element.getAttribute('data-content');
            if (rawContent) {
                element.innerHTML = cleanAndRenderMarkdown(rawContent);
                element.classList.add('markdown-content');
            }
        });
    });

    function copyPath(path) {
        navigator.clipboard.writeText(path).then(function () {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> COPIED!';
            btn.classList.add('text-retro-success', 'border-retro-success');

            setTimeout(function () {
                btn.innerHTML = originalHTML;
                btn.classList.remove('text-retro-success', 'border-retro-success');
            }, 2000);
        }).catch(function (err) {
            console.error('Failed to copy path: ', err);
            alert('Failed to copy path to clipboard');
        });
    }
</script>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2">
    {% for category, message in messages %}
    {% set border_color = 'border-retro-danger' if category == 'error' else 'border-retro-success' %}
    {% set text_color = 'text-retro-danger' if category == 'error' else 'text-retro-success' %}
    <div
        class="alert-dismissible bg-retro-card border-2 {{ border_color }} p-4 shadow-lg max-w-md animate-slide-in-right">
        <div class="flex items-start gap-3">
            <i class="fas fa-info-circle {{ text_color }} mt-1"></i>
            <div class="font-terminal {{ text_color }}">{{ message }}</div>
            <button type="button" class="text-retro-muted hover:text-retro-text ml-auto"
                onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
{% endblock %}