{% extends "base.html" %}

{% block title %}MISSION CONTROL - DOC AGENT{% endblock %}

{% block content %}
<!-- Search Section -->
<div class="relative mb-12">
    <!-- Decorative border -->
    <div class="absolute -inset-1 bg-gradient-to-r from-retro-primary to-retro-secondary rounded-lg blur opacity-25">
    </div>

    <div class="relative bg-retro-card border-2 border-retro-border rounded-lg p-8 box-glow">
        <div class="text-center mb-8">
            <h1 class="font-arcade text-2xl md:text-3xl text-retro-primary mb-4 text-glow-primary">
                <i class="fas fa-search mr-2"></i>SEARCH DOCUMENTS
            </h1>
            <p class="font-terminal text-xl text-retro-muted">
                > INITIALIZING SEARCH PROTOCOLS...<br>
                > ENTER QUERY OR SELECT CATEGORY
            </p>
        </div>

        <form action="{{ url_for('unified_search') }}" method="post" id="unified-search-form" class="max-w-3xl mx-auto">
            <div class="relative group">
                <div
                    class="absolute -inset-0.5 bg-gradient-to-r from-retro-primary to-retro-secondary rounded opacity-50 group-hover:opacity-100 transition duration-200 blur">
                </div>
                <div class="relative flex">
                    <input type="text" name="query" id="search-input"
                        class="w-full bg-retro-bg border-2 border-retro-border text-retro-text font-terminal text-xl p-4 focus:outline-none focus:border-retro-secondary placeholder-retro-muted/50"
                        placeholder="> INPUT SEARCH QUERY..." autocomplete="off" autofocus>
                    <button
                        class="bg-retro-bg border-2 border-l-0 border-retro-border text-retro-secondary px-6 hover:bg-retro-secondary/10 transition-colors"
                        type="submit" id="search-btn">
                        <i class="fas fa-search text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Category suggestions -->
            <div id="category-suggestions" class="mt-4 hidden">
                <div class="text-center">
                    <small class="font-terminal text-retro-muted mb-2 block">> DETECTED CATEGORIES:</small>
                    <div class="flex flex-wrap justify-center gap-3">
                        {% set unique_cats = [] %}
                        {% for doc in recent_docs %}
                        {% for cat in doc.categories.split('-') %}
                        {% if cat and cat not in unique_cats %}
                        {% set _ = unique_cats.append(cat) %}
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                        {% for cat in unique_cats | sort %}
                        <button type="button"
                            class="category-btn font-arcade text-xs px-3 py-2 border border-retro-secondary text-retro-secondary hover:bg-retro-secondary hover:text-retro-bg transition-all duration-300 transform hover:scale-105"
                            data-category="{{ cat }}">
                            [{{ cat | upper }}]
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>

        <div class="text-center mt-6">
            <small class="font-terminal text-retro-muted">
                > EXAMPLES: "TRAVEL DOCUMENTS", "FINANCIAL STATEMENTS", "CONFIRMATION"
            </small>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Recent Documents -->
    <div class="lg:col-span-2">
        <div class="bg-retro-card border-2 border-retro-border rounded-lg overflow-hidden h-full">
            <div class="bg-retro-bg border-b-2 border-retro-border p-4 flex justify-between items-center">
                <h5 class="font-arcade text-sm text-retro-text">
                    <i class="fas fa-clock text-retro-accent mr-2"></i>RECENT_DOCS
                </h5>
                <div class="h-2 w-2 bg-retro-success rounded-full animate-pulse"></div>
            </div>

            <div class="p-4 space-y-4">
                {% if recent_docs %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for doc in recent_docs %}
                    <div
                        class="group bg-retro-bg border border-retro-border p-4 hover:border-retro-primary transition-all duration-300 hover:shadow-[0_0_10px_rgba(255,0,255,0.3)] relative overflow-hidden">
                        <!-- Corner accents -->
                        <div
                            class="absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-retro-secondary opacity-50 group-hover:opacity-100">
                        </div>
                        <div
                            class="absolute top-0 right-0 w-2 h-2 border-t-2 border-r-2 border-retro-secondary opacity-50 group-hover:opacity-100">
                        </div>
                        <div
                            class="absolute bottom-0 left-0 w-2 h-2 border-b-2 border-l-2 border-retro-secondary opacity-50 group-hover:opacity-100">
                        </div>
                        <div
                            class="absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-retro-secondary opacity-50 group-hover:opacity-100">
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="text-2xl text-retro-secondary group-hover:text-retro-primary transition-colors">
                                {{ get_file_icon(doc.metadata.file_extension) }}
                            </div>
                            <div class="flex-grow min-w-0">
                                <h6 class="font-arcade text-xs mb-2 truncate">
                                    <a href="{{ url_for('document_detail', doc_id=doc.id) }}"
                                        class="text-retro-text hover:text-retro-primary transition-colors">
                                        {{ doc.filename }}
                                    </a>
                                </h6>
                                <div class="font-terminal text-sm text-retro-muted mb-2 line-clamp-2 markdown-preview"
                                    data-content="{{ doc.content_preview | truncate_content(100) }}"></div>
                                <div class="flex flex-wrap gap-1 mb-2">
                                    {% for category in doc.categories.split('-') %}
                                    {% if category %}
                                    <span
                                        class="text-[10px] font-arcade px-2 py-1 bg-retro-secondary/10 text-retro-secondary border border-retro-secondary/30 rounded">{{
                                        category | upper }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <small class="font-terminal text-retro-muted block text-right">
                                    {{ doc.classification_date | format_date }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-center mt-6">
                    <a href="{{ url_for('documents') }}" class="btn-retro btn-retro-primary">
                        <i class="fas fa-list mr-2"></i>VIEW ALL LOGS
                    </a>
                </div>
                {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-inbox text-4xl text-retro-muted mb-4 opacity-50"></i>
                    <h5 class="font-arcade text-retro-muted mb-2">NO DATA FOUND</h5>
                    <p class="font-terminal text-retro-muted mb-6">SYSTEM WAITING FOR INPUT...</p>
                    <a href="{{ url_for('documents') }}" class="btn-retro btn-retro-primary">
                        <i class="fas fa-plus mr-2"></i>UPLOAD DATA
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="lg:col-span-1 space-y-8">
        <!-- Quick Stats -->
        <div class="bg-retro-card border-2 border-retro-border rounded-lg overflow-hidden relative group">
            <div class="absolute inset-0 bg-gradient-to-b from-retro-primary/5 to-transparent pointer-events-none">
            </div>
            <div class="p-6">
                <h5 class="font-arcade text-sm text-retro-primary mb-6 text-glow-primary">
                    <i class="fas fa-chart-line mr-2"></i>SYSTEM STATUS
                </h5>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-retro-bg border border-retro-border p-4 rounded relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-retro-secondary"></div>
                        <h3 class="font-arcade text-2xl text-retro-text mb-1">{{ recent_docs | length }}</h3>
                        <small class="font-terminal text-retro-muted text-sm">FILES</small>
                    </div>
                    <div class="bg-retro-bg border border-retro-border p-4 rounded relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-retro-accent"></div>
                        <h3 class="font-arcade text-2xl text-retro-text mb-1">
                            {% set unique_cats = [] %}
                            {% for doc in recent_docs %}
                            {% for cat in doc.categories.split('-') %}
                            {% if cat and cat not in unique_cats %}
                            {% set _ = unique_cats.append(cat) %}
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                            {{ unique_cats | length }}
                        </h3>
                        <small class="font-terminal text-retro-muted text-sm">TYPES</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-retro-card border-2 border-retro-border rounded-lg overflow-hidden">
            <div class="bg-retro-bg border-b-2 border-retro-border p-4">
                <h6 class="font-arcade text-sm text-retro-text">
                    <i class="fas fa-bolt text-retro-accent mr-2"></i>COMMANDS
                </h6>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <a href="{{ url_for('documents') }}" class="btn-retro w-full text-center">
                    <i class="fas fa-file-alt mr-2"></i>BROWSE FILES
                </a>
                <a href="{{ url_for('stats') }}"
                    class="btn-retro w-full text-center border-retro-success text-retro-success hover:text-white hover:bg-retro-success/20">
                    <i class="fas fa-chart-bar mr-2"></i>VIEW METRICS
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2">
    {% for category, message in messages %}
    {% set border_color = 'border-retro-danger' if category == 'error' else 'border-retro-success' %}
    {% set text_color = 'text-retro-danger' if category == 'error' else 'text-retro-success' %}
    <div
        class="alert-dismissible bg-retro-card border-2 {{ border_color }} p-4 shadow-lg max-w-md animate-slide-in-right">
        <div class="flex items-start gap-3">
            <i class="fas fa-info-circle {{ text_color }} mt-1"></i>
            <div class="font-terminal {{ text_color }}">{{ message }}</div>
            <button type="button" class="text-retro-muted hover:text-retro-text ml-auto"
                onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const categorySuggestions = document.getElementById('category-suggestions');
        const categoryButtons = document.querySelectorAll('.category-btn');
        const searchForm = document.getElementById('unified-search-form');

        // Show category suggestions when input is focused and empty
        searchInput.addEventListener('focus', function () {
            if (searchInput.value.trim() === '') {
                categorySuggestions.classList.remove('hidden');
            }
        });

        // Hide category suggestions when clicking outside
        document.addEventListener('click', function (e) {
            if (!searchInput.contains(e.target) && !categorySuggestions.contains(e.target)) {
                categorySuggestions.classList.add('hidden');
            }
        });

        // Handle category button clicks
        categoryButtons.forEach(button => {
            button.addEventListener('click', function () {
                const category = this.getAttribute('data-category');
                searchInput.value = `category:${category}`;
                searchForm.submit();
            });
        });

        // Show/hide category suggestions based on input
        searchInput.addEventListener('input', function () {
            const query = searchInput.value.trim();
            if (query === '') {
                categorySuggestions.classList.remove('hidden');
            } else {
                categorySuggestions.classList.add('hidden');
            }
        });

        // Handle form submission
        searchForm.addEventListener('submit', function (e) {
            const query = searchInput.value.trim();

            // If query starts with "category:", treat it as category search
            if (query.toLowerCase().startsWith('category:')) {
                const category = query.substring(9).trim(); // Remove "category:" prefix
                if (category) {
                    // Change form action to category search
                    searchForm.action = '{{ url_for("category_search") }}';
                    // Update the input name to match what category_search expects
                    searchInput.name = 'category';
                    searchInput.value = category;
                } else {
                    e.preventDefault();
                    alert('Please specify a category after "category:"');
                    return;
                }
            } else {
                // Default to semantic search
                searchForm.action = '{{ url_for("semantic_search") }}';
                searchInput.name = 'query';
            }
        });

        // Render markdown content in recent documents
        const previewElements = document.querySelectorAll('.markdown-preview');
        previewElements.forEach(element => {
            const rawContent = element.getAttribute('data-content');
            if (rawContent) {
                // Clean and render markdown
                const cleaned = rawContent
                    .replace(/<\|ref\|>[^<]*<\|\/ref\|>/g, '')  // Remove reference tags
                    .replace(/<\|det\|>[^<]*<\|\/det\|>/g, '')  // Remove bounding box data
                    .replace(/<\|image\|>[^<]*<\|\/image\|>/g, '')  // Remove image tags
                    .replace(/\n{3,}/g, '\n\n')  // Clean up excessive newlines
                    .trim();

                element.innerHTML = marked.parse(cleaned, {
                    breaks: true,
                    gfm: true
                });

                // Add styling to markdown content
                element.classList.add('markdown-content');
            }
        });
    });
</script>
{% endblock %}